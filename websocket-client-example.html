<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket å®¢æˆ·ç«¯ç¤ºä¾‹</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .connecting {
        background-color: #fff3cd;
        color: #856404;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background-color: #0056b3;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .log {
        border: 1px solid #ddd;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f8f9fa;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin-bottom: 5px;
        padding: 2px;
      }
      .log-info {
        color: #007bff;
      }
      .log-success {
        color: #28a745;
      }
      .log-error {
        color: #dc3545;
      }
      .log-warning {
        color: #ffc107;
      }
      h3 {
        margin-top: 0;
        color: #333;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        text-align: center;
      }
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
      .message-type {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
        margin-right: 5px;
      }
      .type-connected {
        background: #d4edda;
        color: #155724;
      }
      .type-broadcast {
        background: #cce5ff;
        color: #004085;
      }
      .type-room_message {
        background: #fff3cd;
        color: #856404;
      }
      .type-private_message {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”Œ WebSocket å®¢æˆ·ç«¯ç¤ºä¾‹</h1>

    <div class="container">
      <!-- è¿æ¥æ§åˆ¶é¢æ¿ -->
      <div class="panel">
        <h3>ğŸ“¡ è¿æ¥æ§åˆ¶</h3>
        <div id="status" class="status disconnected">æœªè¿æ¥</div>

        <label>WebSocket URL:</label>
        <input type="text" id="wsUrl" value="ws://localhost:3000/ws" />

        <label>ç”¨æˆ·ID (å¯é€‰):</label>
        <input type="text" id="userId" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·ID" />

        <label>ç”¨æˆ·å (å¯é€‰):</label>
        <input type="text" id="username" placeholder="è¾“å…¥ç”¨æˆ·å" />

        <label>é‚®ç®± (å¯é€‰):</label>
        <input type="text" id="email" placeholder="è¾“å…¥é‚®ç®±" />

        <div>
          <input type="checkbox" id="updateDatabase" />
          <label for="updateDatabase">åŒæ—¶æ›´æ–°æ•°æ®åº“</label>
        </div>

        <div>
          <button id="connectBtn" onclick="connect()">è¿æ¥</button>
          <button id="disconnectBtn" onclick="disconnect()" disabled>
            æ–­å¼€è¿æ¥
          </button>
          <button onclick="updateUserInfo()" id="updateUserBtn" disabled>
            æ›´æ–°ç”¨æˆ·ä¿¡æ¯
          </button>
          <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
      </div>

      <!-- æˆ¿é—´ç®¡ç†é¢æ¿ -->
      <div class="panel">
        <h3>ğŸ  æˆ¿é—´ç®¡ç†</h3>

        <label>æˆ¿é—´åç§°:</label>
        <input type="text" id="roomName" placeholder="è¾“å…¥æˆ¿é—´åç§°" />

        <div>
          <button onclick="joinRoom()" id="joinRoomBtn" disabled>
            åŠ å…¥æˆ¿é—´
          </button>
          <button onclick="leaveRoom()" id="leaveRoomBtn" disabled>
            ç¦»å¼€æˆ¿é—´
          </button>
        </div>

        <div style="margin-top: 15px">
          <label>å½“å‰æˆ¿é—´:</label>
          <div id="currentRoom" style="font-weight: bold; color: #007bff">
            æ— 
          </div>
        </div>
      </div>

      <!-- æ¶ˆæ¯å‘é€é¢æ¿ -->
      <div class="panel">
        <h3>ğŸ’¬ å‘é€æ¶ˆæ¯</h3>

        <label>æ¶ˆæ¯ç±»å‹:</label>
        <select id="messageType">
          <option value="broadcast">å¹¿æ’­æ¶ˆæ¯</option>
          <option value="room_message">æˆ¿é—´æ¶ˆæ¯</option>
          <option value="private_message">ç§äººæ¶ˆæ¯</option>
          <option value="ping">å¿ƒè·³æ£€æµ‹</option>
        </select>

        <div id="targetClientDiv" style="display: none">
          <label>ç›®æ ‡å®¢æˆ·ç«¯ID:</label>
          <input
            type="text"
            id="targetClientId"
            placeholder="è¾“å…¥ç›®æ ‡å®¢æˆ·ç«¯ID"
          />
        </div>

        <label>æ¶ˆæ¯å†…å®¹:</label>
        <textarea
          id="messageContent"
          rows="3"
          placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹"
        ></textarea>

        <button onclick="sendMessage()" id="sendBtn" disabled>å‘é€æ¶ˆæ¯</button>
      </div>

      <!-- æœåŠ¡å™¨ç»Ÿè®¡é¢æ¿ -->
      <div class="panel">
        <h3>ğŸ“Š æœåŠ¡å™¨ç»Ÿè®¡</h3>

        <div class="stats" id="statsContainer">
          <div class="stat-card">
            <div class="stat-number" id="totalClients">0</div>
            <div>åœ¨çº¿å®¢æˆ·ç«¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalRooms">0</div>
            <div>æ´»è·ƒæˆ¿é—´</div>
          </div>
        </div>

        <button onclick="refreshStats()">åˆ·æ–°ç»Ÿè®¡</button>
      </div>

      <!-- æ¶ˆæ¯æ—¥å¿— -->
      <div class="panel full-width">
        <h3>ğŸ“ æ¶ˆæ¯æ—¥å¿—</h3>
        <div id="log" class="log"></div>
      </div>
    </div>

    <script>
      let ws = null;
      let clientId = null;
      let currentRoom = null;

      // æ›´æ–°UIçŠ¶æ€
      function updateUI() {
        const connected = ws && ws.readyState === WebSocket.OPEN;

        document.getElementById("connectBtn").disabled = connected;
        document.getElementById("disconnectBtn").disabled = !connected;
        document.getElementById("joinRoomBtn").disabled = !connected;
        document.getElementById("leaveRoomBtn").disabled = !connected;
        document.getElementById("sendBtn").disabled = !connected;
        document.getElementById("updateUserBtn").disabled = !connected;

        document.getElementById("status").className = connected
          ? "status connected"
          : "status disconnected";
        document.getElementById("status").textContent = connected
          ? `å·²è¿æ¥ (ID: ${clientId})`
          : "æœªè¿æ¥";

        document.getElementById("currentRoom").textContent =
          currentRoom || "æ— ";
      }

      // æ·»åŠ æ—¥å¿—
      function addLog(message, type = "info") {
        const log = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = `<span style="color: #666;">[${new Date().toLocaleTimeString()}]</span> ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      // è¿æ¥WebSocket
      function connect() {
        const url = document.getElementById("wsUrl").value;
        const userId = document.getElementById("userId").value;

        document.getElementById("status").className = "status connecting";
        document.getElementById("status").textContent = "è¿æ¥ä¸­...";

        try {
          ws = new WebSocket(url);

          ws.onopen = function (event) {
            addLog("ğŸ”— WebSocketè¿æ¥å·²å»ºç«‹", "success");

            // å¦‚æœè®¾ç½®äº†ç”¨æˆ·IDï¼Œå‘é€ç»™æœåŠ¡å™¨
            if (userId) {
              ws.send(
                JSON.stringify({
                  type: "set_user_info",
                  userId: userId,
                })
              );
            }

            updateUI();
            refreshStats();
          };

          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);
              handleMessage(data);
            } catch (e) {
              addLog(`ğŸ“¥ æ”¶åˆ°éJSONæ¶ˆæ¯: ${event.data}`, "warning");
            }
          };

          ws.onclose = function (event) {
            addLog(
              `ğŸ”Œ è¿æ¥å·²å…³é—­ (ä»£ç : ${event.code}, åŸå› : ${
                event.reason || "æ— "
              })`,
              "warning"
            );
            clientId = null;
            currentRoom = null;
            updateUI();
          };

          ws.onerror = function (error) {
            addLog(`âŒ WebSocketé”™è¯¯: ${error}`, "error");
            updateUI();
          };
        } catch (error) {
          addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, "error");
          updateUI();
        }
      }

      // æ–­å¼€è¿æ¥
      function disconnect() {
        if (ws) {
          ws.close(1000, "ç”¨æˆ·ä¸»åŠ¨æ–­å¼€");
          ws = null;
        }
      }

      // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
      function handleMessage(data) {
        const typeClass = data.type ? `type-${data.type}` : "";
        let logMessage = `ğŸ“¥ <span class="message-type ${typeClass}">${data.type}</span>`;

        switch (data.type) {
          case "connected":
            clientId = data.clientId;
            logMessage += `è¿æ¥æˆåŠŸï¼Œå®¢æˆ·ç«¯ID: ${data.clientId}`;
            break;

          case "joined_room":
            currentRoom = data.room;
            logMessage += `æˆåŠŸåŠ å…¥æˆ¿é—´: ${data.room} (æˆå‘˜æ•°: ${data.roomMemberCount})`;
            break;

          case "left_room":
            currentRoom = null;
            logMessage += `å·²ç¦»å¼€æˆ¿é—´: ${data.room}`;
            break;

          case "user_joined":
            logMessage += `ç”¨æˆ· ${
              data.userId || data.clientId
            } åŠ å…¥äº†æˆ¿é—´ (æˆå‘˜æ•°: ${data.roomMemberCount})`;
            break;

          case "user_left":
            logMessage += `ç”¨æˆ· ${
              data.userId || data.clientId
            } ç¦»å¼€äº†æˆ¿é—´ (æˆå‘˜æ•°: ${data.roomMemberCount})`;
            break;

          case "broadcast":
            logMessage += `å¹¿æ’­æ¶ˆæ¯æ¥è‡ª ${data.fromUserId || data.from}: ${
              data.content
            }`;
            break;

          case "room_message":
            logMessage += `æˆ¿é—´ ${data.room} æ¶ˆæ¯æ¥è‡ª ${
              data.fromUserId || data.from
            }: ${data.content}`;
            break;

          case "private_message":
            logMessage += `ç§äººæ¶ˆæ¯æ¥è‡ª ${data.fromUserId || data.from}: ${
              data.content
            }`;
            break;

          case "pong":
            logMessage += `å¿ƒè·³å“åº”: ${data.timestamp}`;
            break;

          case "user_info_updated":
            logMessage += `ç”¨æˆ·ä¿¡æ¯æ›´æ–°: ${data.message}`;
            if (data.userData) {
              logMessage += ` - ç”¨æˆ·æ•°æ®: ${JSON.stringify(data.userData)}`;
            }
            break;

          case "error":
            logMessage += `é”™è¯¯: ${data.message}`;
            addLog(logMessage, "error");
            return;

          case "server_shutdown":
            logMessage += `æœåŠ¡å™¨é€šçŸ¥: ${data.message}`;
            addLog(logMessage, "warning");
            return;

          default:
            logMessage += `${JSON.stringify(data)}`;
        }

        addLog(logMessage, "success");
        updateUI();
      }

      // åŠ å…¥æˆ¿é—´
      function joinRoom() {
        const roomName = document.getElementById("roomName").value.trim();
        if (!roomName) {
          alert("è¯·è¾“å…¥æˆ¿é—´åç§°");
          return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "join_room",
              room: roomName,
            })
          );
          addLog(`ğŸ  è¯·æ±‚åŠ å…¥æˆ¿é—´: ${roomName}`, "info");
        }
      }

      // ç¦»å¼€æˆ¿é—´
      function leaveRoom() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "leave_room",
            })
          );
          addLog(`ğŸšª è¯·æ±‚ç¦»å¼€å½“å‰æˆ¿é—´`, "info");
        }
      }

      // å‘é€æ¶ˆæ¯
      function sendMessage() {
        const type = document.getElementById("messageType").value;
        const content = document.getElementById("messageContent").value.trim();

        if (!content && type !== "ping") {
          alert("è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹");
          return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
          const message = { type: type };

          if (type === "private_message") {
            const targetClientId = document
              .getElementById("targetClientId")
              .value.trim();
            if (!targetClientId) {
              alert("è¯·è¾“å…¥ç›®æ ‡å®¢æˆ·ç«¯ID");
              return;
            }
            message.targetClientId = targetClientId;
          }

          if (content) {
            message.content = content;
          }

          ws.send(JSON.stringify(message));
          addLog(`ğŸ“¤ å‘é€${type}æ¶ˆæ¯: ${content || "å¿ƒè·³"}`, "info");

          // æ¸…ç©ºæ¶ˆæ¯å†…å®¹
          document.getElementById("messageContent").value = "";
        }
      }

      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      function updateUserInfo() {
        const userId = document.getElementById("userId").value.trim();
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const updateDatabase =
          document.getElementById("updateDatabase").checked;

        if (!userId) {
          alert("è¯·è¾“å…¥ç”¨æˆ·ID");
          return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
          const message = {
            type: "set_user_info",
            userId: userId,
            updateDatabase: updateDatabase,
          };

          // åªåŒ…å«éç©ºçš„å­—æ®µ
          if (username) message.username = username;
          if (email) message.email = email;

          ws.send(JSON.stringify(message));
          addLog(
            `ğŸ“¤ æ›´æ–°ç”¨æˆ·ä¿¡æ¯: ${userId} ${
              updateDatabase ? "(å«æ•°æ®åº“æ›´æ–°)" : "(ä»…WebSocket)"
            }`,
            "info"
          );
        }
      }

      // åˆ·æ–°æœåŠ¡å™¨ç»Ÿè®¡
      async function refreshStats() {
        try {
          const response = await fetch("/api/ws/stats");
          const result = await response.json();

          if (result.success) {
            document.getElementById("totalClients").textContent =
              result.data.totalClients;
            document.getElementById("totalRooms").textContent =
              result.data.totalRooms;
          }
        } catch (error) {
          console.error("è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:", error);
        }
      }

      // æ¸…é™¤æ—¥å¿—
      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      // æ¶ˆæ¯ç±»å‹å˜æ›´å¤„ç†
      document
        .getElementById("messageType")
        .addEventListener("change", function () {
          const targetDiv = document.getElementById("targetClientDiv");
          targetDiv.style.display =
            this.value === "private_message" ? "block" : "none";
        });

      // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        updateUI();

        // å®šæœŸåˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
        setInterval(refreshStats, 5000);

        addLog("ğŸš€ WebSocketå®¢æˆ·ç«¯å·²å‡†å¤‡å°±ç»ª", "info");
      });

      // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
      window.addEventListener("beforeunload", function () {
        if (ws) {
          ws.close();
        }
      });
    </script>
  </body>
</html>
